/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/**
 * Created by bohoffi on 03.04.2017.
 */
import { Directive, ElementRef, EventEmitter, Input, Output } from '@angular/core';
import { fromEvent as observableFromEvent } from 'rxjs';
import { debounceTime, filter } from 'rxjs/operators';
import { getProperty, setProperty } from '../utils';
import { LocalStorageService } from '../services/ngx-localstorage.service';
import { StorageEventService } from '../services/storage-event.service';
var LocalStorageDirective = /** @class */ (function () {
    function LocalStorageDirective(er, lss, es) {
        var _this = this;
        this.er = er;
        this.lss = lss;
        this.es = es;
        this.lsDebounce = 0;
        this.lsInitFromStorage = false;
        this.lsStoredValue = new EventEmitter();
        this._valuePath = [];
        this.es.stream.pipe(
        // TODO: filter should be more accurate
        filter(function (ev) { return ev.key.indexOf(_this.lsKey) >= 0; }))
            .subscribe(function (ev) {
            setProperty(_this._valuePath.length ? _this._valuePath : ['value'], ev.newValue, _this.er.nativeElement, _this.lsFalsyTransformer);
        });
    }
    /**
     * @return {?}
     */
    LocalStorageDirective.prototype.ngAfterViewInit = /**
     * @return {?}
     */
    function () {
        this._initKey();
        this._initFromStorage();
        this._hookEvent();
    };
    Object.defineProperty(LocalStorageDirective.prototype, "lsValuePath", {
        set: /**
         * @param {?} path
         * @return {?}
         */
        function (path) {
            if (path != null) {
                this._valuePath = Array.isArray(path) ? path : path.split(',');
            }
            else {
                this._valuePath = [];
            }
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @private
     * @return {?}
     */
    LocalStorageDirective.prototype._initKey = /**
     * @private
     * @return {?}
     */
    function () {
        if (!this.lsKey) {
            if (!this.er.nativeElement.id && !this.er.nativeElement.name) {
                throw new Error('No key or element id or name supplied!');
            }
            this.lsKey = this.er.nativeElement.id || this.er.nativeElement.name;
        }
    };
    /**
     * @private
     * @return {?}
     */
    LocalStorageDirective.prototype._hookEvent = /**
     * @private
     * @return {?}
     */
    function () {
        var _this = this;
        if (this.lsEvent) {
            this._eventSubscription = observableFromEvent(this.er.nativeElement, this.lsEvent).pipe(debounceTime(this.lsDebounce))
                .subscribe(function () {
                _this.lss.asPromisable().set(_this.lsKey, getProperty(_this._valuePath.length ? _this._valuePath : ['value'], _this.er.nativeElement), _this.lsPrefix)
                    .then(function () {
                    _this.lss.asPromisable().get(_this.lsKey, _this.lsPrefix)
                        .then(function (value) {
                        _this.lsStoredValue.emit(value);
                    })
                        .catch(function (err) { return console.error(err); });
                })
                    .catch(function (err) { return console.error(err); });
            });
        }
    };
    /**
     * @private
     * @return {?}
     */
    LocalStorageDirective.prototype._initFromStorage = /**
     * @private
     * @return {?}
     */
    function () {
        var _this = this;
        if (this.lsInitFromStorage) {
            this.lss.asPromisable().get(this.lsKey, this.lsPrefix)
                .then(function (storedValue) {
                setProperty(_this._valuePath.length ? _this._valuePath : ['value'], storedValue, _this.er.nativeElement, _this.lsFalsyTransformer);
            })
                .catch(function (err) { return console.error(err); });
        }
    };
    /**
     * @return {?}
     */
    LocalStorageDirective.prototype.ngOnDestroy = /**
     * @return {?}
     */
    function () {
        if (this._eventSubscription && !this._eventSubscription.closed) {
            this._eventSubscription.unsubscribe();
        }
    };
    LocalStorageDirective.decorators = [
        { type: Directive, args: [{
                    selector: '[ngxLocalStorage]'
                },] }
    ];
    /** @nocollapse */
    LocalStorageDirective.ctorParameters = function () { return [
        { type: ElementRef },
        { type: LocalStorageService },
        { type: StorageEventService }
    ]; };
    LocalStorageDirective.propDecorators = {
        lsKey: [{ type: Input, args: ['ngxLocalStorage',] }],
        lsPrefix: [{ type: Input }],
        lsEvent: [{ type: Input }],
        lsDebounce: [{ type: Input }],
        lsInitFromStorage: [{ type: Input }],
        lsFalsyTransformer: [{ type: Input }],
        lsStoredValue: [{ type: Output }],
        lsValuePath: [{ type: Input }]
    };
    return LocalStorageDirective;
}());
export { LocalStorageDirective };
if (false) {
    /** @type {?} */
    LocalStorageDirective.prototype.lsKey;
    /** @type {?} */
    LocalStorageDirective.prototype.lsPrefix;
    /** @type {?} */
    LocalStorageDirective.prototype.lsEvent;
    /** @type {?} */
    LocalStorageDirective.prototype.lsDebounce;
    /** @type {?} */
    LocalStorageDirective.prototype.lsInitFromStorage;
    /** @type {?} */
    LocalStorageDirective.prototype.lsFalsyTransformer;
    /** @type {?} */
    LocalStorageDirective.prototype.lsStoredValue;
    /**
     * @type {?}
     * @private
     */
    LocalStorageDirective.prototype._eventSubscription;
    /**
     * @type {?}
     * @private
     */
    LocalStorageDirective.prototype._valuePath;
    /**
     * @type {?}
     * @private
     */
    LocalStorageDirective.prototype.er;
    /**
     * @type {?}
     * @private
     */
    LocalStorageDirective.prototype.lss;
    /**
     * @type {?}
     * @private
     */
    LocalStorageDirective.prototype.es;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LWxvY2Fsc3RvcmFnZS5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZ3gtbG9jYWxzdG9yYWdlLyIsInNvdXJjZXMiOlsibGliL2RpcmVjdGl2ZXMvbmd4LWxvY2Fsc3RvcmFnZS5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUdBLE9BQU8sRUFBZ0IsU0FBUyxFQUFFLFVBQVUsRUFBRSxZQUFZLEVBQUUsS0FBSyxFQUFhLE1BQU0sRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUMzRyxPQUFPLEVBQUMsU0FBUyxJQUFJLG1CQUFtQixFQUFlLE1BQU0sTUFBTSxDQUFDO0FBQ3BFLE9BQU8sRUFBQyxZQUFZLEVBQUUsTUFBTSxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFFcEQsT0FBTyxFQUFDLFdBQVcsRUFBRSxXQUFXLEVBQUMsTUFBTSxVQUFVLENBQUM7QUFDbEQsT0FBTyxFQUFDLG1CQUFtQixFQUFDLE1BQU0sc0NBQXNDLENBQUM7QUFDekUsT0FBTyxFQUFDLG1CQUFtQixFQUFDLE1BQU0sbUNBQW1DLENBQUM7QUFFdEU7SUF3QkUsK0JBQW9CLEVBQWMsRUFDZCxHQUF3QixFQUN4QixFQUF1QjtRQUYzQyxpQkFXQztRQVhtQixPQUFFLEdBQUYsRUFBRSxDQUFZO1FBQ2QsUUFBRyxHQUFILEdBQUcsQ0FBcUI7UUFDeEIsT0FBRSxHQUFGLEVBQUUsQ0FBcUI7UUFkM0MsZUFBVSxHQUFHLENBQUMsQ0FBQztRQUVmLHNCQUFpQixHQUFHLEtBQUssQ0FBQztRQUsxQixrQkFBYSxHQUFHLElBQUksWUFBWSxFQUFPLENBQUM7UUFHaEMsZUFBVSxHQUFhLEVBQUUsQ0FBQztRQU1oQyxJQUFJLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxJQUFJO1FBQ25CLHVDQUF1QztRQUNyQyxNQUFNLENBQUMsVUFBQyxFQUFnQixJQUFLLE9BQUEsRUFBRSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsS0FBSSxDQUFDLEtBQUssQ0FB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Qk4sS0FBSzs7SUFxRFIsNEJBQUM7Q0FBQSxBQWhHRCxJQWdHQztTQTdGWSxxQkFBcUI7OztJQUVoQyxzQ0FDYzs7SUFDZCx5Q0FDaUI7O0lBQ2pCLHdDQUNnQjs7SUFDaEIsMkNBQ2U7O0lBQ2Ysa0RBQzBCOztJQUMxQixtREFDK0I7O0lBRS9CLDhDQUN3Qzs7Ozs7SUFFeEMsbURBQXlDOzs7OztJQUN6QywyQ0FBa0M7Ozs7O0lBRXRCLG1DQUFzQjs7Ozs7SUFDdEIsb0NBQWdDOzs7OztJQUNoQyxtQ0FBK0IiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogQ3JlYXRlZCBieSBib2hvZmZpIG9uIDAzLjA0LjIwMTcuXHJcbiAqL1xyXG5pbXBvcnQge0FmdGVyVmlld0luaXQsIERpcmVjdGl2ZSwgRWxlbWVudFJlZiwgRXZlbnRFbWl0dGVyLCBJbnB1dCwgT25EZXN0cm95LCBPdXRwdXR9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQge2Zyb21FdmVudCBhcyBvYnNlcnZhYmxlRnJvbUV2ZW50LCBTdWJzY3JpcHRpb259IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQge2RlYm91bmNlVGltZSwgZmlsdGVyfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcblxyXG5pbXBvcnQge2dldFByb3BlcnR5LCBzZXRQcm9wZXJ0eX0gZnJvbSAnLi4vdXRpbHMnO1xyXG5pbXBvcnQge0xvY2FsU3RvcmFnZVNlcnZpY2V9IGZyb20gJy4uL3NlcnZpY2VzL25neC1sb2NhbHN0b3JhZ2Uuc2VydmljZSc7XHJcbmltcG9ydCB7U3RvcmFnZUV2ZW50U2VydmljZX0gZnJvbSAnLi4vc2VydmljZXMvc3RvcmFnZS1ldmVudC5zZXJ2aWNlJztcclxuXHJcbkBEaXJlY3RpdmUoe1xyXG4gIHNlbGVjdG9yOiAnW25neExvY2FsU3RvcmFnZV0nXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBMb2NhbFN0b3JhZ2VEaXJlY3RpdmUgaW1wbGVtZW50cyBBZnRlclZpZXdJbml0LCBPbkRlc3Ryb3kge1xyXG5cclxuICBASW5wdXQoJ25neExvY2FsU3RvcmFnZScpXHJcbiAgbHNLZXk6IHN0cmluZztcclxuICBASW5wdXQoKVxyXG4gIGxzUHJlZml4OiBzdHJpbmc7XHJcbiAgQElucHV0KClcclxuICBsc0V2ZW50OiBzdHJpbmc7XHJcbiAgQElucHV0KClcclxuICBsc0RlYm91bmNlID0gMDtcclxuICBASW5wdXQoKVxyXG4gIGxzSW5pdEZyb21TdG9yYWdlID0gZmFsc2U7XHJcbiAgQElucHV0KClcclxuICBsc0ZhbHN5VHJhbnNmb3JtZXI/OiAoKSA9PiBhbnk7XHJcblxyXG4gIEBPdXRwdXQoKVxyXG4gIGxzU3RvcmVkVmFsdWUgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcclxuXHJcbiAgcHJpdmF0ZSBfZXZlbnRTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcclxuICBwcml2YXRlIF92YWx1ZVBhdGg6IHN0cmluZ1tdID0gW107XHJcblxyXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgZXI6IEVsZW1lbnRSZWYsXHJcbiAgICAgICAgICAgICAgcHJpdmF0ZSBsc3M6IExvY2FsU3RvcmFnZVNlcnZpY2UsXHJcbiAgICAgICAgICAgICAgcHJpdmF0ZSBlczogU3RvcmFnZUV2ZW50U2VydmljZSkge1xyXG5cclxuICAgIHRoaXMuZXMuc3RyZWFtLnBpcGUoXHJcbiAgICAvLyBUT0RPOiBmaWx0ZXIgc2hvdWxkIGJlIG1vcmUgYWNjdXJhdGVcclxuICAgICAgZmlsdGVyKChldjogU3RvcmFnZUV2ZW50KSA9PiBldi5rZXkuaW5kZXhPZih0aGlzLmxzS2V5KSA+PSAwKVxyXG4gICAgKVxyXG4gICAgICAuc3Vic2NyaWJlKChldjogU3RvcmFnZUV2ZW50KSA9PiB7XHJcbiAgICAgICAgc2V0UHJvcGVydHkodGhpcy5fdmFsdWVQYXRoLmxlbmd0aCA/IHRoaXMuX3ZhbHVlUGF0aCA6IFsndmFsdWUnXSwgZXYubmV3VmFsdWUsIHRoaXMuZXIubmF0aXZlRWxlbWVudCwgdGhpcy5sc0ZhbHN5VHJhbnNmb3JtZXIpO1xyXG4gICAgICB9KTtcclxuICB9XHJcblxyXG4gIG5nQWZ0ZXJWaWV3SW5pdCgpOiB2b2lkIHtcclxuICAgIHRoaXMuX2luaXRLZXkoKTtcclxuICAgIHRoaXMuX2luaXRGcm9tU3RvcmFnZSgpO1xyXG4gICAgdGhpcy5faG9va0V2ZW50KCk7XHJcbiAgfVxyXG5cclxuICBASW5wdXQoKVxyXG4gIHNldCBsc1ZhbHVlUGF0aChwYXRoOiBhbnlbXSB8IHN0cmluZykge1xyXG4gICAgaWYgKHBhdGggIT0gbnVsbCkge1xyXG4gICAgICB0aGlzLl92YWx1ZVBhdGggPSBBcnJheS5pc0FycmF5KHBhdGgpID8gcGF0aCA6IHBhdGguc3BsaXQoJywnKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMuX3ZhbHVlUGF0aCA9IFtdO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBfaW5pdEtleSgpOiB2b2lkIHtcclxuICAgIGlmICghdGhpcy5sc0tleSkge1xyXG4gICAgICBpZiAoIXRoaXMuZXIubmF0aXZlRWxlbWVudC5pZCAmJiAhdGhpcy5lci5uYXRpdmVFbGVtZW50Lm5hbWUpIHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIGtleSBvciBlbGVtZW50IGlkIG9yIG5hbWUgc3VwcGxpZWQhJyk7XHJcbiAgICAgIH1cclxuICAgICAgdGhpcy5sc0tleSA9IHRoaXMuZXIubmF0aXZlRWxlbWVudC5pZCB8fCB0aGlzLmVyLm5hdGl2ZUVsZW1lbnQubmFtZTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgX2hvb2tFdmVudCgpOiB2b2lkIHtcclxuICAgIGlmICh0aGlzLmxzRXZlbnQpIHtcclxuICAgICAgdGhpcy5fZXZlbnRTdWJzY3JpcHRpb24gPSBvYnNlcnZhYmxlRnJvbUV2ZW50KHRoaXMuZXIubmF0aXZlRWxlbWVudCwgdGhpcy5sc0V2ZW50KS5waXBlKFxyXG4gICAgICAgIGRlYm91bmNlVGltZSh0aGlzLmxzRGVib3VuY2UpKVxyXG4gICAgICAgIC5zdWJzY3JpYmUoKCkgPT4ge1xyXG4gICAgICAgICAgdGhpcy5sc3MuYXNQcm9taXNhYmxlKCkuc2V0KHRoaXMubHNLZXksXHJcbiAgICAgICAgICAgIGdldFByb3BlcnR5KHRoaXMuX3ZhbHVlUGF0aC5sZW5ndGggPyB0aGlzLl92YWx1ZVBhdGggOiBbJ3ZhbHVlJ10sIHRoaXMuZXIubmF0aXZlRWxlbWVudCksXHJcbiAgICAgICAgICAgIHRoaXMubHNQcmVmaXgpXHJcbiAgICAgICAgICAgIC50aGVuKCgpID0+IHtcclxuICAgICAgICAgICAgICB0aGlzLmxzcy5hc1Byb21pc2FibGUoKS5nZXQodGhpcy5sc0tleSwgdGhpcy5sc1ByZWZpeClcclxuICAgICAgICAgICAgICAgIC50aGVuKCh2YWx1ZTogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgIHRoaXMubHNTdG9yZWRWYWx1ZS5lbWl0KHZhbHVlKTtcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAuY2F0Y2goKGVycjogRXJyb3IpID0+IGNvbnNvbGUuZXJyb3IoZXJyKSk7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIC5jYXRjaCgoZXJyOiBFcnJvcikgPT4gY29uc29sZS5lcnJvcihlcnIpKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgX2luaXRGcm9tU3RvcmFnZSgpOiB2b2lkIHtcclxuICAgIGlmICh0aGlzLmxzSW5pdEZyb21TdG9yYWdlKSB7XHJcbiAgICAgIHRoaXMubHNzLmFzUHJvbWlzYWJsZSgpLmdldCh0aGlzLmxzS2V5LCB0aGlzLmxzUHJlZml4KVxyXG4gICAgICAgIC50aGVuKChzdG9yZWRWYWx1ZTogYW55KSA9PiB7XHJcbiAgICAgICAgICBzZXRQcm9wZXJ0eSh0aGlzLl92YWx1ZVBhdGgubGVuZ3RoID8gdGhpcy5fdmFsdWVQYXRoIDogWyd2YWx1ZSddLCBzdG9yZWRWYWx1ZSwgdGhpcy5lci5uYXRpdmVFbGVtZW50LCB0aGlzLmxzRmFsc3lUcmFuc2Zvcm1lcik7XHJcbiAgICAgICAgfSlcclxuICAgICAgICAuY2F0Y2goKGVycjogRXJyb3IpID0+IGNvbnNvbGUuZXJyb3IoZXJyKSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcclxuICAgIGlmICh0aGlzLl9ldmVudFN1YnNjcmlwdGlvbiAmJiAhdGhpcy5fZXZlbnRTdWJzY3JpcHRpb24uY2xvc2VkKSB7XHJcbiAgICAgIHRoaXMuX2V2ZW50U3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcbiJdfQ==